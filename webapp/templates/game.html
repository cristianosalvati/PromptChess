{% extends 'base.html' %}

{% block title %}Game - PromptChess{% endblock %}

{% block content %}
<style>
    .ai-comment {
        background: #f8f9fa;
        border-left: 4px solid #3498db;
        padding: 10px 15px;
        margin-bottom: 15px;
        border-radius: 4px;
        font-style: italic;
        color: #555;
        min-height: 20px;
    }
    .ai-comment:empty::before {
        content: "L'AI commenter√† le mosse qui...";
        color: #999;
    }
    .board-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .files-row {
        display: flex;
        justify-content: center;
        margin-bottom: 5px;
        margin-left: 25px;
    }
    .file-label {
        width: 50px;
        text-align: center;
        font-weight: bold;
        color: #c0392b;
        font-size: 16px;
    }
    .board-with-ranks {
        display: flex;
    }
    .ranks-column {
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        margin-right: 5px;
    }
    .rank-label {
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #c0392b;
        font-size: 16px;
        width: 20px;
    }
    .move-entry {
        padding: 8px;
        border-bottom: 1px solid #eee;
    }
    .move-entry.white-move {
        background: #fff;
    }
    .move-entry.black-move {
        background: #f5f5f5;
    }
    .move-player {
        font-size: 11px;
        font-weight: bold;
        margin-left: 10px;
    }
    .move-player.white {
        color: #27ae60;
    }
    .move-player.black {
        color: #e74c3c;
    }
    .ai-message {
        display: block;
        font-size: 11px;
        color: #e74c3c;
        margin-top: 4px;
        font-style: italic;
    }
</style>

<div class="game-container">
    <div class="game-header">
        <h1>Chess Game</h1>
        <span class="turn-indicator">Turn: {{ current_turn|capitalize }}</span>
    </div>
    
    <div class="game-layout">
        <div class="board-section">
            <div class="ai-comment" id="aiComment"></div>
            
            <div class="board-wrapper">
                <div class="files-row">
                    <div class="file-label">A</div>
                    <div class="file-label">B</div>
                    <div class="file-label">C</div>
                    <div class="file-label">D</div>
                    <div class="file-label">E</div>
                    <div class="file-label">F</div>
                    <div class="file-label">G</div>
                    <div class="file-label">H</div>
                </div>
                <div class="board-with-ranks">
                    <div class="ranks-column">
                        <div class="rank-label">8</div>
                        <div class="rank-label">7</div>
                        <div class="rank-label">6</div>
                        <div class="rank-label">5</div>
                        <div class="rank-label">4</div>
                        <div class="rank-label">3</div>
                        <div class="rank-label">2</div>
                        <div class="rank-label">1</div>
                    </div>
                    <div class="chess-board" id="chessBoard"></div>
                </div>
            </div>
        </div>
        
        <div class="game-panel">
            <div class="move-input">
                <h3>Your Move (White)</h3>
                <form id="moveForm">
                    <div class="form-group">
                        <label for="piece">Piece</label>
                        <select id="piece" name="piece">
                            <option value="P">Pawn</option>
                            <option value="N">Knight</option>
                            <option value="B">Bishop</option>
                            <option value="R">Rook</option>
                            <option value="Q">Queen</option>
                            <option value="K">King</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="from_sq">From</label>
                            <input type="text" id="from_sq" name="from_sq" placeholder="e2" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label for="to_sq">To</label>
                            <input type="text" id="to_sq" name="to_sq" placeholder="e4" maxlength="2">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Make Move</button>
                </form>
            </div>
            
            <div class="move-history">
                <h3>Move History</h3>
                <div class="history-list" id="historyList">
                    {% for move in move_history %}
                    <div class="move-entry {{ 'white-move' if move.player == 'white' else 'black-move' }}">
                        <span class="move-num">{{ move.move_number }}.</span>
                        <span class="move-notation">{{ move.piece }} {{ move.from }}-{{ move.to }}</span>
                        <span class="move-player {{ move.player }}">{{ '(WHITE)' if move.player == 'white' else '(BLACK)' }}</span>
                        {% if move.ai_message %}
                        <span class="ai-message">Messaggio avversario: "{{ move.ai_message }}"</span>
                        {% endif %}
                    </div>
                    {% else %}
                    <p class="no-moves">No moves yet</p>
                    {% endfor %}
                </div>
            </div>
            
            <div class="game-actions">
                <a href="{{ url_for('menu') }}" class="btn btn-secondary">Exit Game</a>
            </div>
        </div>
    </div>
</div>

<script>
    const sessionId = "{{ session_id }}";
    let boardState = {{ board_state|tojson|safe }};
    let currentTurn = "{{ current_turn }}";
    let lastAiComment = "";
    let lastAiMessage = "";
    
    function renderBoard() {
        const board = document.getElementById('chessBoard');
        board.innerHTML = '';
        
        const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
        const ranks = [8, 7, 6, 5, 4, 3, 2, 1];
        
        for (let r of ranks) {
            for (let f of files) {
                const sq = document.createElement('div');
                sq.className = 'square ' + ((files.indexOf(f) + r) % 2 === 0 ? 'dark' : 'light');
                sq.dataset.square = f + r;
                
                const piece = getPieceAt(f, r);
                if (piece) {
                    sq.innerHTML = piece;
                }
                
                board.appendChild(sq);
            }
        }
        
        document.querySelector('.turn-indicator').textContent = 'Turn: ' + currentTurn.charAt(0).toUpperCase() + currentTurn.slice(1);
    }
    
    function getPieceAt(file, rank) {
        const pieceMap = {
            'pedoni': ['P', 'p'],
            'cavalli': ['N', 'n'],
            'alfieri': ['B', 'b'],
            'torri': ['R', 'r'],
            'regina': ['Q', 'q'],
            're': ['K', 'k']
        };
        
        const symbols = {
            'P': '\u2659', 'N': '\u2658', 'B': '\u2657', 'R': '\u2656', 'Q': '\u2655', 'K': '\u2654',
            'p': '\u265F', 'n': '\u265E', 'b': '\u265D', 'r': '\u265C', 'q': '\u265B', 'k': '\u265A'
        };
        
        const sq = file + rank;
        
        for (let pieceType in pieceMap) {
            if (boardState.bianchi && boardState.bianchi[pieceType] && boardState.bianchi[pieceType].includes(sq)) {
                return symbols[pieceMap[pieceType][0]];
            }
            if (boardState.neri && boardState.neri[pieceType] && boardState.neri[pieceType].includes(sq)) {
                return symbols[pieceMap[pieceType][1]];
            }
        }
        
        return null;
    }
    
    function updateAiComment(comment) {
        const commentBox = document.getElementById('aiComment');
        if (comment) {
            commentBox.textContent = 'Commento: "' + comment + '"';
        }
    }
    
    function updateHistory(moveHistory, aiMessage) {
        const historyList = document.getElementById('historyList');
        if (moveHistory && moveHistory.length > 0) {
            historyList.innerHTML = moveHistory.map((m, idx) => {
                const isBlack = m.player === 'black';
                const playerClass = isBlack ? 'black-move' : 'white-move';
                const playerLabel = isBlack ? '(BLACK)' : '(WHITE)';
                const playerColor = isBlack ? 'black' : 'white';
                
                let aiMsgHtml = '';
                if (isBlack && m.ai_message) {
                    aiMsgHtml = `<span class="ai-message">Messaggio avversario: "${m.ai_message}"</span>`;
                } else if (isBlack && idx === moveHistory.length - 1 && aiMessage) {
                    aiMsgHtml = `<span class="ai-message">Messaggio avversario: "${aiMessage}"</span>`;
                }
                
                return `<div class="move-entry ${playerClass}">
                    <span class="move-num">${m.move_number}.</span>
                    <span class="move-notation">${m.piece} ${m.from}-${m.to}</span>
                    <span class="move-player ${playerColor}">${playerLabel}</span>
                    ${aiMsgHtml}
                </div>`;
            }).join('');
        }
    }
    
    document.getElementById('moveForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const piece = document.getElementById('piece').value;
        const from_sq = document.getElementById('from_sq').value.toLowerCase();
        const to_sq = document.getElementById('to_sq').value.toLowerCase();
        
        if (!from_sq || !to_sq) {
            alert('Please enter both From and To squares');
            return;
        }
        
        const submitBtn = e.target.querySelector('button');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Waiting for AI...';
        
        try {
            const response = await fetch(`/api/game/${sessionId}/move`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({piece, from_sq, to_sq})
            });
            
            const data = await response.json();
            
            if (data.success) {
                boardState = data.board_state;
                currentTurn = data.current_turn;
                renderBoard();
                
                if (data.ai_comment) {
                    updateAiComment(data.ai_comment);
                }
                
                updateHistory(data.move_history, data.ai_message);
                
                document.getElementById('from_sq').value = '';
                document.getElementById('to_sq').value = '';
            } else {
                alert('Error: ' + data.error);
            }
        } catch (err) {
            alert('Network error: ' + err.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Make Move';
        }
    });
    
    renderBoard();
</script>
{% endblock %}
